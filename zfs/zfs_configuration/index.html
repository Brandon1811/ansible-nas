
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Build a fully functional NAS with an Ubuntu box and this playbook">
      
      
      
        <meta name="author" content="David Stephens">
      
      
        <link rel="canonical" href="https://davestephens.uk/ansible-nas/zfs/zfs_configuration/">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.4">
    
    
      
        <title>ZFS Configuration - Ansible-NAS</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.75751829.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
      <link rel="manifest" href="../../manifest.webmanifest" crossorigin="use-credentials">
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="indigo">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#zfs-configuration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://davestephens.uk/ansible-nas" title="Ansible-NAS" class="md-header-nav__button md-logo" aria-label="Ansible-NAS">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Ansible-NAS
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              ZFS Configuration
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/davestephens/ansible-nas/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    davestephens/ansible-nas
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://davestephens.uk/ansible-nas" title="Ansible-NAS" class="md-nav__button md-logo" aria-label="Ansible-NAS">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Ansible-NAS
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/davestephens/ansible-nas/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    davestephens/ansible-nas
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  <li class="md-nav__item">
    <a href="../.." class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../../hardware/" class="md-nav__link">
      Hardware
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../../installation/" class="md-nav__link">
      Installation
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../../overview/" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../../post_installation/" class="md-nav__link">
      Post installation
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../../support/" class="md-nav__link">
      Support
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../../testing/" class="md-nav__link">
      Testing
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../../upgrading/" class="md-nav__link">
      Upgrading Ansible-NAS
    </a>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9" >
    
    <label class="md-nav__link" for="nav-9">
      Applications
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Applications" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        <span class="md-nav__icon md-icon"></span>
        Applications
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/airsonic/" class="md-nav__link">
      Airsonic
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/bazarr/" class="md-nav__link">
      Bazarr subtitle downloader
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/bitwarden/" class="md-nav__link">
      Bitwarden(_rs) Password Management
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/calibre/" class="md-nav__link">
      Calibre-web
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/cloudcmd/" class="md-nav__link">
      Cloud Commander file manager
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/cloudflare_ddns/" class="md-nav__link">
      Cloudflare Dynamic DNS Updater
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/couchpotato/" class="md-nav__link">
      CouchPotato
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/duplicati/" class="md-nav__link">
      Duplicati
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/emby/" class="md-nav__link">
      Emby
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/firefly/" class="md-nav__link">
      Firefly III
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/get_iplayer/" class="md-nav__link">
      get_iplayer
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/gitea/" class="md-nav__link">
      Gitea
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/gitlab/" class="md-nav__link">
      GitLab
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/guacamole/" class="md-nav__link">
      Guacamole
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/heimdall/" class="md-nav__link">
      Heimdall
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/homeassistant/" class="md-nav__link">
      Home Assistant
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/homebridge/" class="md-nav__link">
      Homebridge
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/jackett/" class="md-nav__link">
      Jackett
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/jellyfin/" class="md-nav__link">
      Jellyfin
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/joomla/" class="md-nav__link">
      Joomla CMS
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/krusader/" class="md-nav__link">
      Krusader
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/lidarr/" class="md-nav__link">
      Lidarr music collection manager
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/minidlna/" class="md-nav__link">
      MiniDLNA
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/miniflux/" class="md-nav__link">
      Miniflux
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/mosquitto/" class="md-nav__link">
      Mosquitto
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/mylar/" class="md-nav__link">
      Mylar
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/mymediaforalexa/" class="md-nav__link">
      My Media for Alexa
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/nextcloud/" class="md-nav__link">
      Nextcloud
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/nzbget/" class="md-nav__link">
      NZBget
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/ombi/" class="md-nav__link">
      Ombi
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/openhab/" class="md-nav__link">
      openHAB
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/organizr/" class="md-nav__link">
      Organizr
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/pyload/" class="md-nav__link">
      pyLoad
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/pytivo/" class="md-nav__link">
      PyTivo
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/radarr/" class="md-nav__link">
      Radarr
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/sonarr/" class="md-nav__link">
      Sonarr
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/tautulli/" class="md-nav__link">
      Tautulli
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/thelounge/" class="md-nav__link">
      The Lounge
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/timemachine/" class="md-nav__link">
      Time Machine
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/traefik/" class="md-nav__link">
      Traefik
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/transmission/" class="md-nav__link">
      Transmission
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/ubooquity/" class="md-nav__link">
      Ubooquity Comic and Book Server
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/utorrent/" class="md-nav__link">
      uTorrent
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/virtual_desktop/" class="md-nav__link">
      Virtual Desktop
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/wallabag/" class="md-nav__link">
      wallabag
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/watchtower/" class="md-nav__link">
      Watchtower
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../applications/youtubedlmaterial/" class="md-nav__link">
      YouTubeDL-Material
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10" >
    
    <label class="md-nav__link" for="nav-10">
      Configuration
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Configuration" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        <span class="md-nav__icon md-icon"></span>
        Configuration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../../configuration/application_ports/" class="md-nav__link">
      Application Ports
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../configuration/custom_applications/" class="md-nav__link">
      Custom Applications
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../configuration/external_access/" class="md-nav__link">
      External Access
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../configuration/nfs_exports/" class="md-nav__link">
      NFS Exports
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../configuration/samba_shares/" class="md-nav__link">
      Samba Shares
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  


  
  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11" checked>
    
    <label class="md-nav__link" for="nav-11">
      Zfs
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Zfs" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        <span class="md-nav__icon md-icon"></span>
        Zfs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        ZFS Configuration
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      ZFS Configuration
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#just-so-there-is-no-misunderstanding" class="md-nav__link">
    Just so there is no misunderstanding
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-obligatory-warning" class="md-nav__link">
    The obligatory warning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-basic-setup" class="md-nav__link">
    The basic setup
  </a>
  
    <nav class="md-nav" aria-label="The basic setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-pool" class="md-nav__link">
    Creating a pool
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pool-and-filesystem-properties" class="md-nav__link">
    Pool and filesystem properties
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-filesystems" class="md-nav__link">
    Creating filesystems
  </a>
  
    <nav class="md-nav" aria-label="Creating filesystems">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#movies-and-other-large-pre-compressed-files" class="md-nav__link">
    Movies (and other large, pre-compressed files)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downloads" class="md-nav__link">
    Downloads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-data" class="md-nav__link">
    Other data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-scrubs" class="md-nav__link">
    Setting up scrubs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#email-notifications" class="md-nav__link">
    Email notifications
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snapshots" class="md-nav__link">
    Snapshots
  </a>
  
    <nav class="md-nav" aria-label="Snapshots">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#managing-snapshots-by-hand" class="md-nav__link">
    Managing snapshots by hand
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-snapshots-with-sanoid" class="md-nav__link">
    Managing snapshots with Sanoid
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../zfs_overview/" class="md-nav__link">
      ZFS Overview
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#just-so-there-is-no-misunderstanding" class="md-nav__link">
    Just so there is no misunderstanding
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-obligatory-warning" class="md-nav__link">
    The obligatory warning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-basic-setup" class="md-nav__link">
    The basic setup
  </a>
  
    <nav class="md-nav" aria-label="The basic setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-pool" class="md-nav__link">
    Creating a pool
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pool-and-filesystem-properties" class="md-nav__link">
    Pool and filesystem properties
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-filesystems" class="md-nav__link">
    Creating filesystems
  </a>
  
    <nav class="md-nav" aria-label="Creating filesystems">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#movies-and-other-large-pre-compressed-files" class="md-nav__link">
    Movies (and other large, pre-compressed files)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downloads" class="md-nav__link">
    Downloads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-data" class="md-nav__link">
    Other data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-scrubs" class="md-nav__link">
    Setting up scrubs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#email-notifications" class="md-nav__link">
    Email notifications
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snapshots" class="md-nav__link">
    Snapshots
  </a>
  
    <nav class="md-nav" aria-label="Snapshots">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#managing-snapshots-by-hand" class="md-nav__link">
    Managing snapshots by hand
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-snapshots-with-sanoid" class="md-nav__link">
    Managing snapshots with Sanoid
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/davestephens/ansible-nas/edit/master/docs/zfs/zfs_configuration.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="zfs-configuration">ZFS Configuration</h1>
<p>This text deals with specific ZFS configuration questions for Ansible-NAS. If
you are new to ZFS and are looking for the big picture, please read the <a href="../zfs_overview/">ZFS
overview</a> introduction first.</p>
<h2 id="just-so-there-is-no-misunderstanding">Just so there is no misunderstanding</h2>
<p>Unlike other NAS variants, Ansible-NAS does not install, configure or manage the
disks or file systems for you. It doesn't care which file system you use - ZFS,
Btrfs, XFS or EXT4, take your pick. Nor does it provides a mechanism for
snapshots or disk monitoring. As Tony Stark said to Loki in <em>Avengers</em>: It's all
on you.</p>
<p>However, Ansible-NAS has traditionally been used with the powerful ZFS
filesystem. Since out of the box support for <a href="https://zfsonlinux.org/">ZFS on
Linux</a> with Ubuntu is comparatively new, this text
shows how to set up a simple storage configuration. To paraphrase Nick Fury from
<em>Winter Soldier</em>: We do share. We're nice like that.</p>
<blockquote>
<p>Using ZFS for Docker containers is currently not covered by this document. See
<a href="https://docs.docker.com/storage/storagedriver/zfs-driver/">the official Docker ZFS
documentation</a>
instead.</p>
</blockquote>
<h2 id="the-obligatory-warning">The obligatory warning</h2>
<p>We take no responsibility for any bad thing that might happen if you follow this
guide. We strongly suggest you test these procedures in a virtual machine first.
Always, always, always backup your data.</p>
<h2 id="the-basic-setup">The basic setup</h2>
<p>For this example, we're assuming two identical spinning rust hard drives for
Ansible-NAS storage. These two drives will be <strong>mirrored</strong> to provide
redundancy. The actual Ubuntu system will be on a different drive and is not our
concern.</p>
<blockquote>
<p><a href="https://openzfs.github.io/openzfs-docs/Getting%20Started/Ubuntu/Ubuntu%2020.04%20Root%20on%20ZFS.html">Root on ZFS</a>
is possible, but not something that has been tested with Ansible-NAS.</p>
</blockquote>
<p>The Ubuntu kernel is already ready for ZFS. We only need the utility package
which we install with <code>sudo apt install zfsutils</code>.</p>
<h3 id="creating-a-pool">Creating a pool</h3>
<p>We assume you don't mind totally destroying whatever data might be on your two
storage drives, have used a tool such as <code>gparted</code> to remove any existing
partitions, and have installed a new GPT partition table on each drive. To
create our ZFS pool, we will use a command in this form:</p>
<pre><code>        sudo zpool create -o ashift=&lt;ASHIFT&gt; &lt;NAME&gt; mirror &lt;DRIVE1&gt; &lt;DRIVE2&gt;
</code></pre>
<p>The options from simple to complex are:</p>
<p><strong>NAME</strong>: ZFS pools traditionally take their names from characters in the <a href="https://www.imdb.com/title/tt0133093/fullcredits">The
Matrix</a>. The two most common
are <code>tank</code> and <code>dozer</code>. Whatever you use, it should be short - think <code>ash</code>, not
<code>xenomorph</code>.</p>
<p><strong>DRIVES</strong>: The Linux command <code>lsblk</code> will give you a quick overview of the
hard drives in the system. However, we don't pass the drive specification in the
format <code>/dev/sde</code> because this is not persistent. Instead,
<a href="https://github.com/zfsonlinux/zfs/wiki/FAQ#selecting-dev-names-when-creating-a-pool">always use</a>
the output of <code>ls /dev/disk/by-id/</code> to find the drives' IDs. </p>
<p><strong>ASHIFT</strong>: This is required to pass the <a href="https://github.com/zfsonlinux/zfs/wiki/FAQ#advanced-format-disks">sector
size</a> of the
drive to ZFS for optimal performance. You might have to do this by hand because
some drives lie: Whereas modern drives have 4k sector sizes (or 8k for many
SSDs), they will report 512 bytes because Windows XP <a href="https://support.microsoft.com/en-us/help/2510009/microsoft-support-policy-for-4k-sector-hard-drives-in-windows">can't handle 4k
sectors</a>.
ZFS tries to <a href="https://github.com/zfsonlinux/zfs/blob/master/cmd/zpool/zpool_vdev.c">catch the
liars</a> and
use the correct value. However, this sometimes fails, and you have to add it by
hand. </p>
<p>The <code>ashift</code> value is a power of two, so we have <strong>9</strong> for 512 bytes, <strong>12</strong> for
4k, and <strong>13</strong> for 8k. You can create a pool without this parameter and then use
<code>zdb -C | grep ashift</code> to see what ZFS generated automatically. If it isn't what
you think, destroy the pool again and add it manually.</p>
<p>In our pretend case, we use two 3 TB WD Red drives. Listing all drives by ID
gives us something like this, but with real serial numbers:</p>
<pre><code>        ata-WDC_WD30EFRX-68EUZN0_WD-WCCFAKESN01
        ata-WDC_WD30EFRX-68EUZN0_WD-WCCFAKESN02
</code></pre>
<p>WD Reds have a 4k sector size. The actual command to create the pool would then be: </p>
<pre><code>        sudo zpool create -o ashift=12 tank mirror ata-WDC_WD30EFRX-68EUZN0_WD-WCCFAKESN01 ata-WDC_WD30EFRX-68EUZN0_WD-WCCFAKESN02
</code></pre>
<p>Our new pool is named <code>tank</code> and is mirrored. To see information about it, use
<code>zpool status tank</code> (no <code>sudo</code> necessary). If you screwed up (usually with
<code>ashift</code>), use <code>sudo zpool destroy tank</code> and start over <em>now</em> before it's too
late.</p>
<h3 id="pool-and-filesystem-properties">Pool and filesystem properties</h3>
<p>Pools have properties that apply either to the pool itself or to filesystems
created in the pool. You can use the command <code>zpool get all tank</code> to see the
pool properties and <code>zfs get all tank</code> to see the filesystem properties. Most
default values are perfecly sensible, some you'll <a href="https://jrs-s.net/2018/08/17/zfs-tuning-cheat-sheet/">want to
change</a>. Setting
defaults makes life easier when we create our filesystems.</p>
<pre><code>        sudo zpool set autoexpand=on tank
        sudo zfs set atime=off tank
        sudo zfs set compression=lz4 tank
</code></pre>
<p><code>autoexpand=on</code> lets the pool grow when you add larger hard drives. <code>atime=off</code>
means that your system won't update a time stamp every time a file is accessed,
something which would use a lot of resources. Usually, you don't care.
Compression is a no-brainer on modern CPUs and should be on by default (we will
discuss exceptions for compressed media files later).</p>
<h2 id="creating-filesystems">Creating filesystems</h2>
<p>To actually store the data, we need filesystems (also known as "datasets"). For
our very simple default Ansible-NAS setup, we will create two: One filesystem
for movies (<code>movies_root</code> in <code>all.yml</code>) and one for downloads
(<code>downloads_root</code>). </p>
<h3 id="movies-and-other-large-pre-compressed-files">Movies (and other large, pre-compressed files)</h3>
<p>We first create the basic filesystem:</p>
<pre><code>        sudo zfs create tank/movies
</code></pre>
<p>Movie files are usually rather large, already in a compressed format and for
security reasons, the files stored there shouldn't be executable. We change the
properties of the filesystem accordingly:</p>
<pre><code>        sudo zfs set recordsize=1M tank/movies
        sudo zfs set compression=off tank/movies
        sudo zfs set exec=off tank/movies
</code></pre>
<p>The <strong>recordsize</strong> here is set to the currently largest possible value <a href="https://jrs-s.net/2019/04/03/on-zfs-recordsize/">to
increase performance</a> and save
storage. Recall that we used <code>ashift</code> during the creation of the pool to match
the ZFS block size with the drives' sector size. Records are created out of
these blocks. Having larger records reduces the amount of metadata that is
required, because various parts of ZFS such as caching and checksums work on
this level.</p>
<p><strong>Compression</strong> is unnecessary for movie files because they are usually in a
compressed format anyway. ZFS is good about recognizing this, and so if you
happen to leave compression on as the default for the pool, it won't make much
of a difference. </p>
<p><a href="https://zfsonlinux.org/manpages/0.7.13/man8/zfs.8.html#lbAI">By default</a>, ZFS
stores pools directly under the root directory. Also, the filesystems don't have
to be listed in <code>/etc/fstab</code> to be mounted. This means that our filesystem will
appear as <code>/tank/movies</code> if you don't change anything. We need to change the
line in <code>all.yml</code> accordingly: </p>
<pre><code>        movies_root: &quot;/tank/movies&quot;
</code></pre>
<p>You can also set a traditional mount point if you wish with the <code>mountpoint</code>
property. Setting this to <code>none</code> prevents the file system from being
automatically mounted at all. </p>
<p>The filesystems for TV shows, music files and podcasts - all large,
pre-compressed files - should probably take the exact same parameters. </p>
<h3 id="downloads">Downloads</h3>
<p>For downloads, we can leave most of the default parameters the way they are. </p>
<pre><code>        sudo zfs create tank/downloads
        sudo zfs set exec=off tank/downloads
</code></pre>
<p>The recordsize stays the 128 KB default. In <code>all.yml</code>, the new line is</p>
<pre><code>        downloads_root: &quot;/tank/downloads&quot;
</code></pre>
<h3 id="other-data">Other data</h3>
<p>Depending on the use case, you might want to create and tune more filesystems.
For example, <a href="http://open-zfs.org/wiki/Performance_tuning#Bit_Torrent">Bit
Torrent</a>,
<a href="http://open-zfs.org/wiki/Performance_tuning#MySQL">MySQL</a> and <a href="http://open-zfs.org/wiki/Performance_tuning#Virtual_machines">Virtual
Machines</a> all have
known best configurations. </p>
<h2 id="setting-up-scrubs">Setting up scrubs</h2>
<p>On Ubuntu, scrubs are configured out of the box to run on the second Sunday of
every month. See <code>/etc/cron.d/zfsutils-linux</code> to change this.</p>
<h2 id="email-notifications">Email notifications</h2>
<p>To have the <a href="http://manpages.ubuntu.com/manpages/bionic/man8/zed.8.html">ZFS
demon</a> <code>zed</code> send
you emails when there is trouble, you first have to <a href="https://www.reddit.com/r/zfs/comments/90prt4/zed_config_on_ubuntu_1804/">install an email
agent</a>
such as postfix. In the file <code>/etc/zfs/zed.d/zed.rc</code>, change the three entries:</p>
<pre><code>ZED_EMAIL_ADDR=&lt;YOUR_EMAIL_ADDRESS_HERE&gt;
ZED_NOTIFY_INTERVAL_SECS=3600
ZED_NOTIFY_VERBOSE=1
</code></pre>
<p>If <code>zed</code> is not enabled, you might have to run <code>systemctl enable zed</code>. You can
test the setup by manually starting a scrub with <code>sudo zpool scrub tank</code>. </p>
<h2 id="snapshots">Snapshots</h2>
<p>Snapshots create a "frozen" version of a filesystem, providing a safe copy of
the contents. Correctly configured, they provide good protection against
accidental deletion and certain types of attacks such as ransomware. On
copy-on-write (COW) filesystems such as ZFS, they are cheap and fast to create.
It is very rare that you <em>won't</em> want snapshots.</p>
<blockquote>
<p>Snapshots do not replace the need for backups. Nothing replaces the need for
backups except more backups.</p>
</blockquote>
<h3 id="managing-snapshots-by-hand">Managing snapshots by hand</h3>
<p>If you have data in a filesystem that never or very rarely changes, it might be
easiest to just take a snapshot by hand after every major change. Use the <code>zfs
snapshot</code> command with the name of the filesystem combined with an identifier
separated by the <code>@</code> sign. Traditionally, this somehow includes the date of the
snapshot, usually in some variant of the <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO
8601</a> format.</p>
<pre><code>        zfs snapshot tank/movies@2019-04-24
</code></pre>
<p>To see the list of snapshots in the system, run</p>
<pre><code>        zfs list -t snapshot 
</code></pre>
<p>To revert ("roll back") to the previous snapshot, use the <code>zfs rollback</code>
command. </p>
<pre><code>        zfs rollback tank/movies@2019-04-24
</code></pre>
<p>By default, you can only roll back to the most recent snapshot. Anything before
then requires trickery outside the scope of this document. Finally, to get rid
of a snapshot, use the <code>zfs destroy</code> command.</p>
<pre><code>        zfs destroy tank/movies@2019-04-24
</code></pre>
<blockquote>
<p>Be <strong>very</strong> careful with <code>destroy</code>. If you leave out the snapshot identifier
and only list the filesystem - in our example, <code>tank/movies</code> - the filesystem
itself will immediately be destroyed. There will be no confirmation prompt,
because ZFS doesn't believe in that sort of thing.</p>
</blockquote>
<h3 id="managing-snapshots-with-sanoid">Managing snapshots with Sanoid</h3>
<p>Usually, you'll want the process of creating new and deleting old snapshots to
be automatic, especially on filesystems that change frequently. One tool for
this is <a href="https://github.com/jimsalterjrs/sanoid/">sanoid</a>. There are various
instructions for setting it up, the following is based on notes from
<a href="https://www.svennd.be/zfs-snapshots-of-proxmox-using-sanoid/">SvennD</a>. For this
example, we'll assume we have a single dataset <code>tank/movies</code> that holds, ah,
movies. </p>
<p>First, we install sanoid to the <code>/opt</code> directory. This assumes that Perl itself
is already installed.</p>
<pre><code>        sudo apt install libconfig-inifiles-perl libcapture-tiny-perl
        cd /opt
        sudo git clone https://github.com/jimsalterjrs/sanoid
</code></pre>
<p>It is probably easiest to link sanoid to <code>/usr/sbin</code>: </p>
<pre><code>        sudo ln /opt/sanoid/sanoid /usr/sbin/
</code></pre>
<p>Then we need to setup the configuration files. </p>
<pre><code>        sudo mkdir /etc/sanoid
        sudo cp /opt/sanoid/sanoid.conf /etc/sanoid/sanoid.conf
        sudo cp /opt/sanoid/sanoid.defaults.conf /etc/sanoid/sanoid.defaults.conf
</code></pre>
<p>We don't change the defaults file, but it has to be copied to the folder anyway.
Next, we edit the <code>/etc/sanoid/sanoid.conf</code> configuration file in two steps: We
design the "templates" and then tell sanoid which filesystems to use it on. </p>
<p>The configuration file included with sanoid contains a "production" template for
filesystems that change frequently. For media files, we assume that there is not
going to be that much change from day-to-day, and especially there will be very
few deletions. We use snapshots because this provides protection against
cryptolocker attacks and against accidental deletions. </p>
<blockquote>
<p>Again, snapshots, even lots of snapshots, do not replace backups. </p>
</blockquote>
<p>For our example, we configure for two hourly snapshots (against "oh crap"
deletions), 31 daily, one monthly and one yearly snapshot.</p>
<pre><code>        [template_media]
                frequently = 0
                hourly = 2
                daily = 31
                monthly = 1
                yearly = 1
                autosnap = yes
                autoprune = yes
</code></pre>
<p>That might seem like a bunch of daily snapshots, but remember, if nothing has
changed, a ZFS snapshot is basically free. </p>
<p>Once we have an entry for the template, we assign it to the filesystem.</p>
<pre><code>        [tank/movies]
                use_template = media
</code></pre>
<p>Finally, we edit <code>/etc/crontab</code> to run sanoid every five minutes:</p>
<pre><code>        */5 * * * * root /usr/sbin/sanoid --cron
</code></pre>
<p>After five minutes, you should see the first snapshots (use <code>zfs list -t
snapshot</code> again). The list will look something like this mock example: </p>
<pre><code>NAME                                                USED  AVAIL  REFER  MOUNTPOINT
tank/movies@autosnap_2019-05-17_13:55:01_yearly      0B      -  1,53G  -
tank/movies@autosnap_2019-05-17_13:55:01_monthly     0B      -  1,53G  -
tank/movies@autosnap_2019-05-17_13:55:01_daily       0B      -  1,53G  -
</code></pre>
<p>Note that the snapshots use no storage, because we haven't changed anything. </p>
<p>This is a very simple use of sanoid. Other functions include running scripts
before and after snapshots, and setups to help with backups. See the included
configuration files for examples.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../../configuration/samba_shares/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Samba Shares
              </div>
            </div>
          </a>
        
        
          <a href="../zfs_overview/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                ZFS Overview
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 - 2020 David Stephens
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/davestephens" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>